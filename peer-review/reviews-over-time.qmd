---
title: pyOpenSci Software Peer Review Over Time
format:
  dashboard:
    scrolling: true
execute:
  echo: false
---

```{python}
import warnings
from datetime import datetime
from pathlib import Path

import altair as alt
import pandas as pd

from pyosmeta import ProcessIssues
from pyosmeta.github_api import GitHubAPI
from pyosmetrics.plot_theme import load_poppins_font, register_and_enable_poppins_theme

pd.options.mode.chained_assignment = None
pd.options.future.infer_string = True

# Suppress all warnings
warnings.filterwarnings("ignore")

# Load & register Poppins font and theme for the page
load_poppins_font()
register_and_enable_poppins_theme()

current_date = datetime.today().date()
today = current_date.strftime("%d %B %Y")  # YYYY-MM-DD

```

```{python}

# ===================================================
# ---------- Load & clean data  --------- #
# ===================================================

current_dir = Path.cwd()
data_dir = current_dir.parents[0] / "_data"

reviews = pd.read_csv(data_dir / "review_submissions.csv", parse_dates=["date_opened", "date_closed"])
contribs_data = pd.read_csv(data_dir / "review_contribs.csv", parse_dates=["date_added"])
presubmissions = pd.read_csv(data_dir / "review_presubmissions.csv", parse_dates=["date_opened", "date_closed"])

# -------- SUMMARY COUNTS (used in value boxes) -------- #

total_review_submissions = len(reviews)
total_presubmissions = len(presubmissions)

maintainers = contribs_data[contribs_data["maintainer"]]
total_maintainers = len(maintainers)

# Count reviewer types
columns = ["packages_reviewed", "packages_editor", "packages_eic"]
counts = {col: int((contribs_data[col] > 0).sum()) for col in columns}

# ===================================================
#-------- Review status counts --------#
# ===================================================

# Status counts (for status bar chart)
review_status_ct = reviews["status"].value_counts().reset_index()
review_status_ct["status"] = review_status_ct["status"].replace({
    "seeking editor": "seeking-editor",
    "on hold": "on-hold",
    "out of scope": "out of-scope"
})

# Accepted reviews by year
accepted_reviews = reviews[reviews["date_accepted"] != "missing"].copy()
accepted_reviews["date_accepted"] = pd.to_datetime(accepted_reviews["date_accepted"], errors="coerce")
total_accepted = (
    accepted_reviews
    .groupby(accepted_reviews["date_accepted"].dt.year)
    .size()
    .reset_index(name="count")
    .rename(columns={"date_accepted": "year"})
)
total_accepted["year"] = total_accepted["year"].astype(int)

# ============================================================
# ALL SUBMISSIONS (reviews + presubmissions combined)
# ============================================================

all_submissions = pd.concat([
    reviews.assign(type="submission"),
    presubmissions.assign(type="presubmission")
])
all_submissions["year"] = all_submissions["date_opened"].dt.year
all_submissions["year_month"] = all_submissions["date_opened"].dt.to_period("M")
all_submissions["year_quarter"] = all_submissions["date_opened"].dt.to_period("Q")
all_submissions["month"] = all_submissions["date_opened"].dt.strftime("%b")

# By year (for annual bar chart)
issues_by_year = (
    all_submissions
    .groupby("year")
    .size()
    .reset_index(name="count")
    .sort_values("year", ascending=False)
)

# By quarter (for quarterly bar chart)
quarterly_counts = (
    all_submissions["year_quarter"]
    .value_counts()
    .sort_index()
    .reset_index()
)
quarterly_counts["year_quarter"] = quarterly_counts["year_quarter"].astype(str)

# By month (summed across all years)
month_order = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
monthly_counts = (
    all_submissions
    .groupby("month")
    .size()
    .reindex(month_order, fill_value=0)
    .reset_index(name="count")
)


# ============================================================
# CUMULATIVE SUBMISSIONS (reviews only, for line chart)
# ============================================================
monthly_reviews = (
    reviews
    .set_index(reviews["date_opened"].dt.to_period("M"))
    .groupby(level=0)
    .size()
)

all_month_years = pd.period_range(
    start=reviews["date_opened"].min(),
    end=reviews["date_opened"].max(),
    freq="M"
)

final_monthly = (
    monthly_reviews
    .reindex(all_month_years, fill_value=0)
    .to_frame(name="issue_count")
)
final_monthly["cumulative_count"] = final_monthly["issue_count"].cumsum()
final_monthly = final_monthly.reset_index(names="date")
final_monthly["date"] = final_monthly["date"].dt.to_timestamp()

```

*Last updated: **`{python} today`***

## Row {height=auto}

```{python}
#| content: valuebox
#| title: "Total Reviewers"

dict(
  icon = "people-fill",
  color = "primary",
  value = counts["packages_reviewed"]
)
```

```{python}
#| content: valuebox
#| title: "Total Editor in Chief"
# fails if the value isn't an int
dict(
  icon = "box2-heart",
  color = "primary",
  value = counts["packages_eic"]
)
```

```{python}
#| content: valuebox
#| title: "Total Maintainers"
# fails if the value isn't an int
dict(
  icon = "person-hearts",
  color = "primary",
  value = total_maintainers
)
```

```{python}
#| content: valuebox
#| title: "Total Submissions"
# fails if the value isn't an int
dict(
  icon = "person-hearts",
  color = "primary",
  value = total_review_submissions
)
```
```{python}
#| content: valuebox
#| title: "Total Presubmission Inquiries"
# fails if the value isn't an int
dict(
  icon = "person-hearts",
  color = "primary",
  value = total_presubmissions
)
```

```{python}
#| content: valuebox
#| title: "Total Editors"
# fails if the value isn't an int
dict(
  icon = "person-hearts",
  color = "primary",
  value = counts["packages_editor"]
)
```

## Row {height=auto}

```{python}
# Review counts by current status in our review system
chart = (
    alt.Chart(review_status_ct)
    .mark_bar()
    .transform_calculate(status_wrapped="split(datum.status, '-')"
    ).encode(
        x=alt.X(
            "status_wrapped:N",
            title="",
            sort=[
                "pre-review",
                "seeking editor",
                "under-review",
                "pyos-accepted",
                "joss-accepted",
                "on-hold",
                "out-of-scope",
            ],
        axis=alt.Axis(),
        ),
        y=alt.Y(
            "count",
            axis=alt.Axis(tickCount=5),
            title="Count",
            scale=alt.Scale(domain=[0, 30]),
        ),
        tooltip=[
            alt.Tooltip("status:N", title="Status"),
            alt.Tooltip("count:Q", title="Count"),
        ],
    )
    .properties(title="Total Reviews by Status", width="container", height=500)
)


# Display the chart
chart.show()
```


## Row {height=auto}

```{python}
chart = (
    alt.Chart(total_accepted)
    .mark_bar(color="purple", size=80)
    .encode(
        x=alt.X(
            "year:O",
            title="Year",
            axis=alt.Axis(
                labelAngle=0,  # Horizontal
                labelFontSize=16,
            ),
        ),
        y=alt.Y(
            "count:Q",
            title="Accepted Packages",
            scale=alt.Scale(domain=[0, 20]),
            axis=alt.Axis(tickCount=5, titlePadding=10),
        ),
        tooltip=[
            alt.Tooltip("year:O", title="Year"),
            alt.Tooltip("count:Q", title="Total Packages"),
        ],
    )
    .properties(
        title="Number of Packages Accepted by Year",
        width="container",
    )
)

chart.show()
```


```{python}
# This plot shows total submissions including presubmissions
chart = (
    alt.Chart(issues_by_year)
    .mark_bar(color="purple")
    .encode(
        x=alt.X(
            "year:O",
            axis=alt.Axis(labelAngle=0, labelFontSize=14, titleFontSize=18),
            sort=alt.EncodingSortField(field="year", order="ascending"),
        ),
        y=alt.Y(
            "count:Q",
            axis=alt.Axis(labelFontSize=14, titleFontSize=18, tickCount=5),
        ),
        tooltip=["year", "count"],
    )
    .properties(
        title=alt.TitleParams(
            text="Total Number of Submissions by Year", fontSize=24
        ),
        width=600,
    )
)

chart.show()
```


## Row {height=auto}


```{python}
axis_labels = """datum.label == '2019Q1' ? '2019 Q1' :
                datum.label == '2020Q1' ? '2020 Q1' :
                datum.label == '2021Q1' ? '2021 Q1' :
                datum.label == '2022Q1' ? '2022 Q1' :
                datum.label == '2023Q1' ? '2023 Q1' :
                datum.label == '2024Q1' ? '2024 Q1' :
                '' """
chart = (
    alt.Chart(quarterly_counts)
    .mark_bar(color="purple")
    .encode(
        x=alt.X(
            "year_quarter:O",
            title="Year-Quarter",
            axis=alt.Axis(
                labelAngle=0,
                labelExpr=axis_labels,
            ),
        ),
        y=alt.Y(
            "count:Q",
            title="Number of Submissions",
            axis=alt.Axis(tickCount=4, tickMinStep=4),
            scale=alt.Scale(domain=[0, 12]),
        ),
        tooltip=[
            alt.Tooltip("year_quarter:O", title="Quarter"),
            alt.Tooltip("count:Q", title="Number of Issues"),
        ],
    )
    .properties(
        title="Number of Submissions by Quarter per Year",
        width="container",
        height=400,
    )
)

chart.show()
```

## Row {height=auto}


```{python}

# Create the Altair plot
chart = (
    alt.Chart(monthly_counts)
    .mark_bar()
    .encode(
        x=alt.X(
            "month",
            sort=[
                "Jan",
                "Feb",
                "Mar",
                "Apr",
                "May",
                "Jun",
                "Jul",
                "Aug",
                "Sep",
                "Oct",
                "Nov",
                "Dec",
            ],
        ),
        y="count",
        tooltip=["month", "count"],
    )
    .properties(title="Total Counts per Month (2019-2024)", width="container", height=400)
    .configure_axis(labelAngle=0)
)

chart.show()
```


```{python}
# Create an Altair line plot
chart = (
    alt.Chart(final_monthly)
    .mark_line(color="purple", strokeWidth=8)
    .encode(
        x=alt.X(
            "date:T",
            axis=alt.Axis(
                title="Month",
                format="%b-%Y",
                tickCount="year",
            ),
        ),
        y=alt.Y(
            "cumulative_count:Q",
            axis=alt.Axis(
                title="Number of Issues",
                #tickMinStep=10,  # Not sure why altair isn't recognizing
                tickCount=10,
            ),
        ),
        tooltip=[
            alt.Tooltip("date:T", title="Month"),
            alt.Tooltip("cumulative_count:Q", title="Number of Issues"),
        ],
    )
    .properties(
        title=alt.TitleParams(
            text="Cumulative Review Submissions Over Time",
        ),
        width=600,
        height=400,
    )
)

label = (
    alt.Chart(
        pd.DataFrame(
            {
                "date": [
                    pd.Timestamp("2023-01-01")
                ],  # Specific x-axis location (January 2023)
                "cumulative_count": [16],
                "label": ["Full Time Funding"],
            }
        )
    )
    .mark_text(align="left", dx=5, dy=-10, color="black", fontSize=12, font="Poppins")
    .encode(x="date:T", y="cumulative_count:Q", text="label:N")
)

# Adding an arrow using mark_rule and mark_point
arrow = (
    alt.Chart(
        pd.DataFrame(
            {
                "date": [pd.Timestamp("2023-01-01")],
                "cumulative_count": [
                    20
                ],  # Adjust y-axis location to position the arrow
            }
        )
    )
    .mark_point(shape="triangle", angle=0, size=50, color="black")
    .encode(x="date:T", y="cumulative_count:Q")
)

# Combine the chart and the label
final_chart = chart + label + arrow

# Show the final chart
final_chart.show()

```
